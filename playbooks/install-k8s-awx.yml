---
#########################################################
# PLAY 1: BUILD DYNAMIC INVENTORY
#########################################################
- name: Build dynamic inventory
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Validate survey inputs
      fail:
        msg: "target_vm_ip and target_vm_user are required"
      when: target_vm_ip is not defined or target_vm_user is not defined

    - name: Add target VM
      add_host:
        name: k8s-master
        groups: k8s_master
        ansible_host: "{{ target_vm_ip }}"
        ansible_user: "{{ target_vm_user }}"
        ansible_become: true
        ansible_become_method: sudo

    - name: Show target
      debug:
        msg: "Installing Kubernetes + AWX on {{ target_vm_user }}@{{ target_vm_ip }}"

#########################################################
# PLAY 2: INSTALL KUBERNETES + AWX (FULLY AUTOMATED)
#########################################################
- name: Install Kubernetes and AWX
  hosts: k8s_master
  become: true
  gather_facts: true

  environment:
    DEBIAN_FRONTEND: noninteractive

  vars:
    k8s_version: "1.29"
    pod_network_cidr: "10.244.0.0/16"
    kubeconfig: /etc/kubernetes/admin.conf
    awx_namespace: awx

  handlers:
    - name: restart containerd
      systemd:
        name: containerd
        state: restarted
        enabled: true

    - name: restart kubelet
      systemd:
        name: kubelet
        state: restarted
        enabled: true

  tasks:
    #####################################################
    # OS PRE-REQS
    #####################################################
    - name: Disable swap
      command: swapoff -a
      ignore_errors: true

    - name: Remove swap from fstab
      replace:
        path: /etc/fstab
        regexp: '^.*swap.*$'
        replace: ''

    #####################################################
    # CLEAN APT STATE
    #####################################################
    - name: Remove broken Docker repo
      file:
        path: /etc/apt/sources.list.d/docker.list
        state: absent

    - name: Update apt cache
      apt:
        update_cache: yes

    #####################################################
    # BASE PACKAGES
    #####################################################
    - name: Install base packages
      apt:
        name:
          - curl
          - ca-certificates
          - gnupg
          - apt-transport-https
          - cri-tools
        lock_timeout: 600

    #####################################################
    # CONTAINERD (CRI)
    #####################################################
    - name: Add Docker GPG key
      shell: |
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
        | gpg --dearmor -o /usr/share/keyrings/docker.gpg
      args:
        creates: /usr/share/keyrings/docker.gpg

    - name: Add Docker repo
      copy:
        dest: /etc/apt/sources.list.d/docker.list
        content: |
          deb [arch=amd64 signed-by=/usr/share/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable

    - name: Update apt cache (Docker)
      apt:
        update_cache: yes

    - name: Install containerd
      apt:
        name: containerd.io
        lock_timeout: 600

    - name: Configure containerd
      shell: |
        mkdir -p /etc/containerd
        containerd config default > /etc/containerd/config.toml
        sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
      notify: restart containerd

    - name: Configure crictl
      copy:
        dest: /etc/crictl.yaml
        content: |
          runtime-endpoint: unix:///run/containerd/containerd.sock
          image-endpoint: unix:///run/containerd/containerd.sock

    #####################################################
    # KERNEL + SYSCTL (REBOOT REQUIRED)
    #####################################################
    - name: Load kernel modules
      shell: |
        modprobe overlay
        modprobe br_netfilter

    - name: Configure sysctl
      copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1

    - name: Apply sysctl
      command: sysctl --system

    #####################################################
    # ðŸ”´ CRITICAL: REBOOT + WAIT (SSH SAFE)
    #####################################################
    - name: Reboot node after kernel changes
      reboot:
        reboot_timeout: 600
        test_command: whoami

    - name: Wait for SSH
      wait_for_connection:
        timeout: 300

    #####################################################
    # KUBERNETES INSTALL
    #####################################################
    - name: Add Kubernetes GPG key
      shell: |
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/deb/Release.key \
        | gpg --dearmor -o /usr/share/keyrings/k8s.gpg

    - name: Add Kubernetes repo
      copy:
        dest: /etc/apt/sources.list.d/kubernetes.list
        content: |
          deb [signed-by=/usr/share/keyrings/k8s.gpg] https://pkgs.k8s.io/core:/stable:/v{{ k8s_version }}/deb/ /

    - name: Update apt cache (K8s)
      apt:
        update_cache: yes

    - name: Install Kubernetes packages
      apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        lock_timeout: 600

    - name: Hold Kubernetes packages
      command: apt-mark hold kubelet kubeadm kubectl

    #####################################################
    # CLUSTER INIT
    #####################################################
    - name: Reset Kubernetes if exists
      command: kubeadm reset -f
      ignore_errors: true

    - name: Validate CRI
      command: crictl info
      register: cri
      retries: 10
      delay: 5
      until: cri.rc == 0

    - name: Initialize Kubernetes
      command: kubeadm init --pod-network-cidr={{ pod_network_cidr }}
      args:
        creates: "{{ kubeconfig }}"

    #####################################################
    # CNI
    #####################################################
    - name: Install Flannel
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      command: kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml

    #####################################################
    # WAIT FOR NODE READY (ABSOLUTE MUST)
    #####################################################
    - name: Wait for node Ready
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      shell: kubectl get nodes --no-headers | awk '{print $2}'
      register: node_status
      retries: 30
      delay: 10
      until: node_status.stdout == "Ready"

    #####################################################
    # AWX INSTALL (AUTOMATED)
    #####################################################
    - name: Create AWX namespace
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      command: kubectl create namespace {{ awx_namespace }}
      ignore_errors: true

    - name: Install AWX Operator
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      command: kubectl apply -k github.com/ansible/awx-operator/config/default?ref=release-2.12.0

    - name: Create AWX CR
      copy:
        dest: /tmp/awx.yml
        content: |
          apiVersion: awx.ansible.com/v1beta1
          kind: AWX
          metadata:
            name: awx
            namespace: {{ awx_namespace }}
          spec:
            service_type: NodePort
            replicas: 1

    - name: Apply AWX CR
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      command: kubectl apply -f /tmp/awx.yml
