---
#########################################################
# PLAY 1: BUILD DYNAMIC INVENTORY FROM SURVEY INPUT
#########################################################
- name: Build dynamic inventory
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Validate required survey inputs
      fail:
        msg: "Both target_vm_ip and target_vm_user are required from survey"
      when: target_vm_ip is not defined or target_vm_user is not defined

    - name: Add target VM dynamically
      add_host:
        name: k8s-master
        groups: k8s_master
        ansible_host: "{{ target_vm_ip }}"
        ansible_user: "{{ target_vm_user }}"
        ansible_become: true
        ansible_become_method: sudo

    - name: Show target VM details
      debug:
        msg: "Installing Kubernetes + AWX on {{ target_vm_user }}@{{ target_vm_ip }}"

#########################################################
# PLAY 2: INSTALL KUBERNETES + AWX
#########################################################
- name: Install Kubernetes and AWX
  hosts: k8s_master
  become: true
  gather_facts: false

  environment:
    DEBIAN_FRONTEND: noninteractive

  vars:
    pod_network_cidr: "10.244.0.0/16"
    k8s_version: "1.29"
    awx_namespace: "{{ awx_namespace | default('awx') }}"
    kubeconfig: /etc/kubernetes/admin.conf

  handlers:
    - name: restart containerd
      systemd:
        name: containerd
        state: restarted

  tasks:
    #####################################################
    # OS PRE-REQS
    #####################################################
    - name: Disable swap
      command: swapoff -a
      ignore_errors: true

    - name: Remove swap from fstab
      replace:
        path: /etc/fstab
        regexp: '^.*swap.*$'
        replace: ''

    - name: Install base packages
      apt:
        name:
          - curl
          - ca-certificates
          - apt-transport-https
          - gnupg
          - containerd
        update_cache: yes
        lock_timeout: 600

    #####################################################
    # CONTAINERD (CRI FIX)
    #####################################################
    - name: Configure containerd (enable CRI)
      shell: |
        mkdir -p /etc/containerd
        containerd config default > /etc/containerd/config.toml
        sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
        sed -i 's/disabled_plugins = \["cri"\]/disabled_plugins = []/' /etc/containerd/config.toml
      notify: restart containerd

    - name: Enable and start containerd
      systemd:
        name: containerd
        enabled: true
        state: started

    #####################################################
    # KERNEL + SYSCTL (REQUIRED BY K8s)
    #####################################################
    - name: Load kernel modules
      shell: |
        modprobe overlay
        modprobe br_netfilter

    - name: Set sysctl params for Kubernetes
      copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridg
